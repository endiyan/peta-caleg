<!DOCTYPE html>
<html>
  <head>
    <title>Peta Caleg</title>
    <!-- third-party (vendor) scripts -->
    <script src="js/vendor/aight.min.js"></script>
    <script src="js/vendor/d3.v3.min.js"></script>
    <script src="js/vendor/qs.min.js"></script>
    <!-- Google Maps - TODO: add API key -->
    <script src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;v=3.14&amp;libraries=geometry,places"></script>
    <!-- Peta Caleg (local) scripts -->
    <script src="js/peta_caleg.js"></script>
    <script src="js/peta_caleg.api.js"></script>
    <script src="js/peta_caleg.router.js"></script>

    <link rel="stylesheet" href="css/peta_caleg.css">
  </head>
  <body>
    <div id="header">
      <h1>Peta Caleg</h1>
      <div id="nav">
        <a href="#DPD">DPD</a>
        <a href="#DPR">DPR</a>
        <a href="#DPRDI">DPRDI</a>
      </div>
    </div>

    <div id="bodies" class="none">
      <div id="DPD" class="body">
        <h2>DPD</h2>
      </div>
      <div id="DPR" class="body">
        <h2>DPR</h2>
      </div>
      <!--
      <div id="DPRDI" class="body">
        <h2>DPRDI</h2>
      </div>
      -->
    </div>

    <script>

    var pc = peta_caleg,
        win = d3.select(window)
          .on("hashchange", hashchange)
          .on("load", init),
        map,
        bodies = d3.select("#bodies"),
        api = pc.api()
          .key("7941b0baecd128c4de3a9ae63a85fd2c"),
        route = pc.router()
          .match("DPD", function(req) {
            setContext({
              body: "DPD"
            });
          })
          .match("DPD/provinsi/{provinsi}", function(req) {
            setContext({
              body: "DPD",
              province: req.data.provinsi
            });
          })
          .match("DPR", function(req) {
            setContext({
              body: "DPR",
            });
          })
          .match("DPR/provinsi/{provinsi}", function(req) {
            setContext({
              body: "DPR",
              province: req.data.provinsi
            });
          })
          .match("DPR/provinsi/{provinsi}/dapil/{dapil}", function(req) {
            setContext({
              body: "DPR",
              province: req.data.provinsi,
              district: req.data.dapil
            });
          })
          .match("DPR/provinsi/{provinsi}/dapil/{dapil}/caleg/{caleg}", function(req) {
            setContext({
              body: "DPR",
              province: req.data.provinsi,
              district: req.data.dapil,
              candidate: req.data.caleg
            });
          })
          /*
          .match("DPRDI", function(req) {
            console.log("DPRDI root", req.data);
            setView("DPRDI");
          })
          .match("DPRDI/dapil/{dapil}", function(req) {
            var districtId = req.data.dapil;
            console.log("DPRDI district:", districtId);
            setView("DPRDI");
            listProvinces(function() {
              selectProvince(districtId);
            });
          })
          */
          .notfound(function(req) {
            console.error("404:", req.url);
          });

    function init() {
      map = new google.maps.Map(document.getElementById("map"), {
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: pc.geo.bounds.getCenter(),
        zoom: 5
      });

      map.fitBounds(pc.geo.bounds);

      if (location.hash) {
        hashchange();
      } else {
        location.hash = "#DPD";
      }
    }

    function hashchange() {
      var hash = location.hash.substr(1);
      route(hash);
    }

    function setContext(context, callback) {
      function done(error) {
        if (error) console.warn("error:", error);
        if (callback) callback.apply(null, arguments);
      }

      setView(context.body, function(error, view) {
        if (error) return done(error);
        view.call(listProvinces, context, function(error, provinces) {
          if (error) return done(error);
          else if (!context.province) return done();

          provinces.call(selectProvince, context, function(error, province) {
            console.log("selected province:", province.datum());
            if (error) return done(error);

            // if we're in the DPD, provinces have candidates
            if (context.body === "DPD") {

              return province.call(listCandidates, context, function(error, candidates) {
                if (error) return done(error);

                if (context.candidate) {
                  candidates.call(selectCandidate, context, function(error, candidate) {
                    return done(error);
                  });
                }
              });

            } else {

              return province.call(listDistricts, context, function(error, districts) {
                if (error) return done(error);

                if (contex.district) {
                  return districts.call(selectDistrict, context, function(error, district) {
                    if (error) return done(error);
                    district.call(listCandidates, context, function(error, candidates) {
                      if (error) return done(error);
                      if (!context.candidate) return done();

                      return candidates.call(selectCandidate, context, function(error, candidate) {
                        return done(error);
                      });
                    });
                  });
                } else {
                  done();
                }
              });

            }
          });
        });
      });
    }

    function setView(id, callback) {
      // get a reference to the view object
      var root = d3.select("#" + id);

      if (root.empty()) {
        console.error("no such view:", id);
        return;
      }


      // toggle the active state of all body-specific elements
      bodies
        .attr("class", id)
        .style("display", null)
        .selectAll(".body")
          .classed("active", function() {
            return this.id === id;
          });

      // abort the last active API request, if there is one
      api.abort();

      if (callback) callback(null, root);
    }

    function listProvinces(selection, context, callback) {
      var list = selection.select(".provinces");
      if (list.empty()) {
        list = selection.append("div")
          .attr("class", "provinces");
      }
      list
        .classed("loading", true)
        .classed("error", false);
      return api.get("provinsi", function(error, res) {
        list.classed("loading", false)
          .classed("error", !!error);

        if (error) return callback(error);

        var provinces = res.results.provinsi;

        if (error) {
          return callback ? callback(error) : null;
        }

        console.log("provinces:", provinces);
        var items = list.selectAll(".province")
              .data(provinces, function(d) {
                return d.id;
              }),
            enter = items.enter()
              .append("div")
                .attr("class", "province");

        items.exit().remove();

        enter.append("h3")
          .append("a")
            .attr("href", function(d) {
              return "#" + getProvinceId(d);
            })
            .text(function(d) {
              return d.nama;
            });

        enter.append("div")
          .attr("class", "map");

        items
          .attr("id", getProvinceId)
          .classed("selected", false);

        if (callback) callback(null, items);
      });

      function getProvinceId(d) {
        return [context.body, "provinsi", d.id].join("/");
      }
    }

    function selectProvince(list, context, callback) {
      var children = list
            .classed("selected", function(d) {
              return d.id == context.province;
            }),
          selected = children.filter(".selected"); // XXX
      if (callback) {
        return selected.empty()
          ? callback("no such province: " + provinceId)
          : callback(null, selected);
      }
    }

    function listDistricts(selection, context, callback) {
    }

    function selectDistrict(selection, context, callback) {
    }

    function listCandidates(selection, context, callback) {
      var list = selection.select(".candidates");
      if (list.empty()) {
        list = selection.append("div")
          .attr("class", "candidates");
      }

      var params = {
        lembaga: context.body,
        province: context.province
      };
      switch (context.body) {
        case "DPD":
          // no districts (dapil)
          break;
        case "DPR":
        case "DPRDI":
          params.provinsi = context.province;
          params.dapil = context.dapil;
          break;
      }

      list
        .classed("loading", true)
        .classed("error", false);
      return api.get("caleg", params, function(error, res) {
        list
          .classed("loading", false)
          .classed("error", !!error);
        if (error) return callback(error);

        var candidates = res.results.caleg;
        console.log("got candidates:", candidates);
      });
    }

    function selectCandidate(selection, context, callback) {
    }

    </script>
  </body>
</html>
